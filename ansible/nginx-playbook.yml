---
include:
  - project: 'OSPO/pipelinecli-ospo'
    file: '/templates/plugins/fossa/.fossa-steps.yml'
    ref: fossa-multi-rg

stages:
  - build-app
  - scan
  - report

variables:
  MAVEN_CLI_OPTS: "-Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  METTA_APPLICATION: "springbootfossa"
  METTA_COMPONENT: "fossamavendemo"
  SHIELD_TEAM: "springbootfossa"
  CARID: 9895
  LOB: "OSPO"
  
  # NEW: Add Datadog configuration
  DD_API_KEY: $DD_API_KEY
  DD_SITE: "datadoghq.com"

# Step 1: Build cowsay-app (YOUR EXISTING BUILD)
build-app:
  stage: build-app
  tags:
    - fossa
  image: maven:3.8.6-openjdk-11
  before_script:
    - apt-get update && apt-get install -y ca-certificates
    - cp ci/settings.xml ~/.m2/settings.xml
    - cp ci/usbank-root-ca.crt /usr/local/share/ca-certificates/usbank-root-ca.crt
    - update-ca-certificates
    - echo "[INFO] Java version $(java -version 2>&1 | head -n 1)"
  script:
    - mvn clean package -DskipTests $MAVEN_CLI_OPTS
    - mvn dependency:copy-dependencies
    - java -cp "target/cowsay-app-1.0.0.jar:target/dependency/*" com.example.app.Main
  artifacts:
    paths:
      - target/
    expire_in: 1 hour
  only:
    - main

# Step 2: Fossa scan stage (YOUR EXISTING FOSSA SCAN)
fossa-analyze:
  extends: .fossa-scan-template
  stage: scan
  image: "artifactory.us.bank-dns.com:5000/shieldplatform/pipeline-cli-testing/fossa:5563250"
  tags:
    - shield
  variables:
    FOSSA_API_KEY: ${FOSSA_API_KEY}
    FOSSA_RELEASE_GROUPS: "Fossa-Maven-Demo"
    FOSSA_RELEASE_VERSION: "1.1.0"
    FOSSA_TEAM: "9895_FOSSA"
  only:
    - main

# NEW: Step 3: Send FOSSA results to Datadog
fossa-to-datadog:
  stage: report
  image: python:3.11-alpine
  needs: ["fossa-analyze"]
  tags:
    - shield
  cache:
    key: ${CI_COMMIT_REF_SLUG}-fossa-datadog
    paths:
      - .pip-cache/
  before_script:
    - apk add --no-cache curl bash jq
    - pip install --cache-dir .pip-cache requests
    - curl -H 'Cache-Control: no-cache' https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh | bash
  script:
    - |
      echo "Fetching FOSSA scan results..."
      
      # Get FOSSA results
      set +e
      fossa test --json > fossa_results.json
      FOSSA_EXIT_CODE=$?
      set -e
      
      echo "FOSSA exit code: $FOSSA_EXIT_CODE"
      
      # Send to Datadog
      python3 scripts/fossa_to_datadog.py \
        --fossa-results fossa_results.json \
        --exit-code $FOSSA_EXIT_CODE \
        --dd-api-key "$DD_API_KEY" \
        --dd-site "$DD_SITE" \
        --project-name "$CI_PROJECT_NAME" \
        --project-id "$CI_PROJECT_ID" \
        --pipeline-id "$CI_PIPELINE_ID" \
        --branch "${CI_COMMIT_BRANCH:-main}" \
        --commit-sha "${CI_COMMIT_SHA:-unknown}"
      
      echo "âœ“ Results sent to Datadog"
  artifacts:
    paths:
      - fossa_results.json
    expire_in: 30 days
    when: always
  allow_failure: true  # Won't break pipeline if Datadog fails
  only:
    - main

